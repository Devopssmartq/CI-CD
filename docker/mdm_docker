# Stage 1: Set up Ubuntu environment and install dependencies
FROM ubuntu:22.04 AS ubuntu-base

# Set environment variable for non-interactive package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install required dependencies for MDM and other utilities
RUN apt-get update && \
    apt-get install -y \
    curl \
    wget \
    unzip \
    git \
    python3 \
    python3-pip \
    sudo \
    postgresql \
    systemd \
    openjdk-11-jre \
    && apt-get clean

# Copy the MDM install script into the image
COPY hmdm_install.sh /scripts/hmdm_install.sh
RUN chmod +x /scripts/hmdm_install.sh

# Stage 2: Set up Tomcat using the official Tomcat image
FROM tomcat:9.0-jdk11-openjdk AS tomcat-base

# Copy the MDM web application (WAR file or unpacked directory) into Tomcat
COPY ./mdm-webapp /usr/local/tomcat/webapps/mdm

# Expose necessary ports
EXPOSE 8080 443

# Stage 3: Final image (combining Ubuntu and Tomcat setup)
FROM ubuntu-base

# Copy necessary files from the previous stages
COPY --from=tomcat-base /usr/local/tomcat /usr/local/tomcat

# Copy entrypoint and installation scripts from the Ubuntu stage
COPY --from=ubuntu-base /scripts/hmdm_install.sh /scripts/hmdm_install.sh

# Set the working directory and make the script executable
RUN chmod +x /scripts/hmdm_install.sh

# Set up the entry point script to start Tomcat and systemd
COPY entrypoint.sh /scripts/entrypoint.sh
RUN chmod +x /scripts/entrypoint.sh

# Set the default command to start Tomcat
ENTRYPOINT ["/scripts/entrypoint.sh"]
