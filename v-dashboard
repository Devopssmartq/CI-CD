pipeline {
  agent {
        kubernetes {
            //label 'jenkins-private-cluster-0'
            defaultContainer 'jnlp'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: jnlp
    image: "jenkins/inbound-agent:3107.v665000b_51092-15"    
    resources:
    requests:
        memory: "2048Mi"
        cpu: "500m"
    limits:
        memory: "4096Mi"
        cpu: "1000m"
  - name: gcloud
    image: google/cloud-sdk:latest
    command:
    - sleep
    args:
    - 99d
    tty: true
  - name: nodejs
    image: node:latest
    command:
    - cat
    tty: true
    '''
        }
    }
  tools {nodejs "NodeJs"}
  
  environment {
    //APP_NAME = 'web-ort'
    APP_ENGINE_PROJECT_ID = 'sqinternational-cicd'
    //APP_ENGINE_SERVICE = 'smart-service'
    APP_ENGINE_VERSION = 'v1'
 
  }
  stages {
    stage('pulling from unified_webstack') {
      steps {
          git branch: 'devops',
                credentialsId: 'bitbucket api',
                url: 'https://yash123devops@bitbucket.org/bottlelabtech/unified_webstack.git'

            sh "ls -lrt"
        }
    }
    stage('Build unified repo ') {
        steps {
            container('nodejs') {
                dir ('${WORKSPACE}/frontend') {
                    sh 'npm install -g gulp'
                    sh 'gulp build_vdashboard'
                    dir ('dist/vdashboard/admindashboard'){
                        sh 'ls *'
                        sh 'pwd'
                    }
                }
            } 
        }
                    
    }         
    // stage('pulling from generic admin dasboard') {
    //   steps {
    //       git branch: 'devops',
    //             credentialsId: 'bitbucket api',
    //             url: 'https://yash123devops@bitbucket.org/bottlelabtech/generic-admin-dashboard.git'

    //         sh "ls"
    //     }
    // }
    // stage('Build') {
    //     steps {
    //         container('nodejs') {
    //             //sh 'npm cache clean --force'
    //             //sh 'rm -rf node_modules'
    //             sh 'npm install'
    //             sh 'CI=false npm run build'
    //             //sh 'npm run build'
    //             sh 'ls'
    //             sh 'pwd'
    //             dir ('build') {
    //                 sh 'echo changing to directory'
    //                 sh 'ls -l'
    //             }
    //         }             
    //     }
    // }    
    stage('pulling from smartq cloud backend') {
      steps {
            git branch: 'devops-check',
                credentialsId: 'bitbucket api',
                url: 'https://yash123devops@bitbucket.org/bottlelabtech/smartq-cloud-backend.git'

            sh "ls"
            dir ('py3_project/py3_backend/bqreports/reports/'){
                sh 'rm -rf ./{*,.*}'
            }
        }
    }    
    stage('copying the files from unified repo to smartq cloud backend repo'){
        steps{
            dir ('${WORKSPACE}/frontend') {
                sh 'ls'
                    dir ('dist/vdashboard/admindashboard'){
                        sh 'ls '
                        sh 'pwd'
                    }
                sh 'cp -r /home/jenkins/agent/workspace/V_Dashboard/frontend/dist/vdashboard/admindashboard/*  /home/jenkins/agent/workspace/V_Dashboard/py3_project/py3_backend/bqreports/reports/'
                    dir ('/home/jenkins/agent/workspace/V_Dashboard/py3_project/py3_backend/bqreports/reports/'){
                        sh 'ls'
                    }     
            }
        }
    }
    // stage('copying the files from generic admin dashboard repo to smqrtq cloud backend repo'){
    //     steps{
    //         dir ('/home/jenkins/agent/workspace/V_Dashboard/build'){
    //             sh 'ls'
    //             sh 'cp -r /home/jenkins/agent/workspace/V_Dashboard/build/ /home/jenkins/agent/workspace/V_Dashboard/py3_project/py3_backend/bqreports/admindashboard/'
    //             sh 'ls'       
                     
    //         }
    //     }
    // } 
    // stage('Deploy to ') {
    //     steps {
    //         container('gcloud') {
    //             // git branch: 'devops',
    //             // credentialsId: 'bitbucket api',
    //             // url: 'https://yash123devops@bitbucket.org/bottlelabtech/smartq-cloud-backend.git'

    //             //sh "ls"
    //             dir ('/home/jenkins/agent/workspace/V_Dashboard/py3_project'){
    //                 sh 'ls'
    //                 sh 'find . -type f -name "*.yaml"'
    //                 sh 'gcloud config set project $APP_ENGINE_PROJECT_ID'
    //                 sh 'gcloud app deploy --version=$APP_ENGINE_VERSION --quiet bqreports.yaml --no-promote'
    //             }
    //         }
    //     }
    // }
  }
}