pipeline {
    agent {
        kubernetes {
            yaml '''
        apiVersion: v1
        kind: Pod
        environment:
            name: "NODE_OPTIONS"
            value: "--max-old-space-size=4096"
        spec:
          containers:
          - name: jnlp  
            resources:
              requests:
                memory: "2048Mi"
                cpu: "500m"
              limits:
                memory: "4096Mi"
                cpu: "1000m"
                
          - name: gcloud
            image: google/cloud-sdk:latest
            command:
            - cat
            tty: true
        '''        
        }
    }

    environment {
        APP_ENGINE_PROJECT_ID = 'sqpreprod-us'
        ENVIRONMENT='auto-sprint'
        VERSION_NUMBER = VersionNumber([
            versionNumberString: '${BUILD_DATE_FORMATTED, "yyyyMMdd"}-${BUILDS_TODAY}', 
            //versionPrefix: 'v1.0.', 
            worstResultForIncrement: 'SUCCESS'
        ])
    }
     
    stages {
        stage('Git checkOut - sq_microservices_backend') { 
            steps { 
                sh "mkdir -p sq_microservices_backend"
                dir('sq_microservices_backend') {                        
                    git branch: 'master',
                    credentialsId: 'bitbucket api',
                    url: 'https://yash123devops@bitbucket.org/bottlelabtech/sq_microservices_backend.git'
                                   
                sh 'ls -lrt'
                }
            } 
        }

        stage('Build') {
            steps {
                sh 'ls'
                dir('cloud_run_longrun_script ') {         
                    container('gcloud') {
                        sh 'gcloud builds submit "gs://sqinternational-cicd.appspot.com/${ENVIRONMENT}" --tag=gcr.io/smartqdemo/app'
                    }             
                }      
            }
        }
    }
}